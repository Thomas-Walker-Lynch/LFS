#!/bin/bash

if [[ "$LFS_ENV" != "m1_root" ]];then
  echo $(basename "$0") "must be run in env_m1_root"
  exit 1
fi

m2fs_unmount
if test $? -ne 0; then
  echo "m2fs_unmount failed, no format done"
  exit 1
fi

mkfs.ext4 $LFS_M2_DEVICE_FS
err_mkm2fs=$?

mkfs.msdos $LFS_M2_DEVICE_EFI
err_mkfsefi=$?

# mount $LFS_M2_DEVICE_FS then initialize its selinx labels, unmount it
err_test_umount=0
err_sel_label=0
if $LFS_M2_SELINUX && test $err_mkm2fs -eq 0 && test $err_mkfsefi -eq 0;then
  pushd /mnt >& /dev/null
  if tmp_mnt=$(mktemp -d --tmpdir=/mnt);then
    if mount $LFS_M2_DEVICE_FS $tmp_mnt >& /dev/null && restorecon -R $tmp_mnt;then
      umount $LFS_M2_DEVICE_FS
      err_test_umount=$?
    fi
    rmdir "$tmp_mnt"
  else
    err_sel_label=1     
  fi
  popd >& /dev/null
fi

if test $err_mkm2fs -ne 0;then
  echo "mkfs.ext4 LFS_M2_DEVICE_FS, $LFS_M2_DEVICE_FS, failed"
  exit 1
fi
if test $err_mkfsefi -ne 0;then
  echo "mkfs.msdos LFS_M2_DEVICE_EFI, $LFS_M2_DEVICE_EFI, failed"
  exit 2
fi
if test $err_sel_label -ne 0;then
  echo "could not set selinux labels for file system"
  exit 3
fi
if test $err_test_umount -ne 0;then
  echo "umount of $tmp_mnt failed"
  exit 4
fi
exit 0
   

#!/bin/bash
#
# A checkpoint is just an tar file made from the m2 filesystem placed into the $LFS_BUILD_DIR/checkpoint directory.
#
# Tar does not take into mounts or special file systems, so checkpointing doesn't make much sense after those steps.
#
# Checkpoints take a lot of disk space. Keeping them around can lead to 'out of disk space' errors pretty quickly. These
# can be subtles.  Typically just a bunch of "can't make/save file" without much explanation.
#
# On a modern high performance system it is just about as fast to run the install again instead of checkpointing,
# and this is also a more effective use of diskspace.
#
# This is here mainly because the book suggests at one point to do an archive, i.e. to check point the install thus far
#
set -x

if [[ -z "$LFS_BUILD_DIR" ]];then
  echo $0 "requires variable \$LFS_BUILD_DIR to be set"
  exit 1
fi

checkpoint="$1"
if [[ -z "$checkpoint" ]];then
  echo $0 "warning has no checkpoint name parameter - making generic 'checkpoint'"
  checkpoint="checkpoint"
fi

checkpoint_dir="$LFS_BUILD_DIR/checkpoint"
if [[ -d "$checkpoint_dir" ]];then
  mkdir -p "$checkpoint_dir"  || { echo $0 "failed to make checkpoint_dir" || exit 1 ; }
fi

checkpoint_file=$(mktemp --tmpdir="$checkpoint_dir" "$checkpoint.XXXXX.tgz")

echo $0 "$checkpoint_file" "$LFS_M2_FILESYSTEM" 
tar -czf $checkpoint_file "$LFS_M2_FILESYSTEM"

set +x

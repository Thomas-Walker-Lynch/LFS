#!/bin/bash
# bash without -i resets PS1
# Make the top of the m2 tree the root of the file system, then run the script
set -x

script="$@"
if [[ -z "$script" ]]; then
  script="/bin/bash --norc"
fi

if [[ -z "$LFS_M2_FILESYSTEM" ]];then
  echo $0 "requires variable LFS_M2_FILESYSTEM to be set"
  exit 1
fi

if [[ -z "$TERM" ]];then
  echo $0 "requires variable TERM to be set"
  exit 2
fi

# LFS_BUILD_DIR _after_ the chroot
LFS_BUILD_DIR_M2="$LFS_M2_FILESYSTEM/mnt/build"
mount --bind "$LFS_BUILD_DIR" "$LFS_BUILD_DIR_M2"
chroot "$LFS_M2_FILESYSTEM" /usr/bin/env -i "$LFS_BUILD_DIR_M2/executable/environment_book_m2-1"\
  "$TERM"\
  "$PPS1"\
  "$PPS2"\
  "$PROJECT"\
  "$LFS_BUILD_DIR_M2"\
  "$LFS_FRAME_LOG"\
  "$LFS_BUILD_LOG"\
  $script

set +x

#!/bin/bash
# bash without -i resets PS1
# Make the top of the m2 tree the root of the file system, then run the script
#set -x

script=$@
if [[ -z "$script" ]];then
  echo $0 "requires script to call"
  exit
fi

if [[ -z "$M2_ROOT" ]];then
  echo $0 "requires variable M2_ROOT to be set"
  exit
fi

if [[ -z "$TERM" ]];then
  echo $0 "requires variable TERM to be set"
  exit
fi

wrapped=$(mktemp --tmpdir="$M2_ROOT/tmp")
if [ $? -ne 0 ]; then
  echo "$0: couldn't create temp"
  exit 2
fi
wrapped_basename=$(basename "$wrapped")
chmod u+x "$wrapped"


# Variables with the $ expand now.  Those with \$ remain as part of the document.
cat >"$wrapped" <<-EOF

	# according to the book	   
	HOME=/root		    
	TERM="$TERM"		    
	# set PS below ...  PS1='(lfs chroot) u:w$ ' 
	PATH=/usr/bin:/usr/sbin
	export HOME TERM PATH

        # other stuff it seems we might need
	umask 022
	M2_ROOT=/		    
	LC_ALL=POSIX
	PATH=/usr/sbin/LFS:"\$PATH"
	MAKEFLAGS='-j12'  # this might cause problems for some builds
	export LFS_ENVIRONMENT M2_ROOT LC_ALL PATH MAKEFLAGS 

        # repo environment
	PROJECT="LFS-book-m2"
	export PROJECT

	# for our build scripts
	BUILD_LOG="build.log"
	FRAME_LOG="frame.log"
	export BUILD_LOG FRAME_LOG        

	# prompt so that dirtrack works in emacs, timezone
        PS1='\n\$(/usr/sbin/LFS/Z)[\$PROJECT]\n\u@\h§\$PWD§\n> '
        PS2='>> '
	TZ=UTC
	TIME_STYLE=long-iso
        export PPS1 PPS2 PS1 PS2 TZ TIME_STYLE

        # a little funny, might be that we should have a build directory under root or some such
	cd /sbin/LFS

	$script
EOF

chroot "$M2_ROOT" /usr/bin/env -i "/tmp/$wrapped_basename"

#set +x

#!/bin/bash
echo \#--------------------------------------------------------------------------------
echo \# $0

# book is bad about telling us what working directory we should be in for running these commands...

cd $M2_ROOT/source

#--------------------------------------------------------------------------------
# ../lib from $M2_ROOT/lib64 is the same as $M2_ROOT/lib, however after we do a changeroot a symlink to an absolute location
# relative to the old root would be a bad thing.
#
# ../lib/ld-linux-x86-64.so.2 currently does not exist.  It is ok to have a symlink to nowhere, but at some point there
# will have to be a library to find at that location.
#
# So there are two unsual things here.  First off we are not in source directory created by expanding the tar file, yet
# the book says that is where builds are supposed to start.  Secondly the source file does not exist (the link target).
# We assume it will exist in the future.
#
case $(uname -m) in
    i?86)   ln -sfv ld-linux.so.2 $M2_ROOT/lib/ld-lsb.so.3
    ;;
    x86_64) ln -sfv ../lib/ld-linux-x86-64.so.2 $M2_ROOT/lib64
            ln -sfv ../lib/ld-linux-x86-64.so.2 $M2_ROOT/lib64/ld-lsb-x86-64.so.3
    ;;
esac

#--------------------------------------------------------------------------------
# now we build the package

source package_untar "glibc"

mkdir -v build
cd build

echo "rootsbindir=/usr/sbin" > configparms

../configure                             \
      --prefix=/usr                      \
      --host=$M2_ROOT_TGT                    \
      --build=$(../scripts/config.guess) \
      --enable-kernel=3.2                \
      --with-headers=$M2_ROOT/usr/include    \
      libc_cv_slibdir=/usr/lib

# book says this is normal:
# configure: WARNING:
# *** These auxiliary programs are missing or incompatible versions: msgfmt

make
make DESTDIR=$M2_ROOT install
sed '/RTLDLIST=/s@/usr@@g' -i $M2_ROOT/usr/bin/ldd

#--------------------------------------------------------------------------------
# run a test compile

echo 'int main(){}' > dummy.c
$M2_ROOT_TGT-gcc dummy.c
readelf -l a.out | grep '/ld-linux'

# If everything is working correctly, there should be no errors, and the output of the last command will be of the form:
# [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]

rm -v dummy.c a.out

#--------------------------------------------------------------------------------
# not really sure what this is doing.  mkheaders is a program that reads C source and creates headers

$M2_ROOT/tools/libexec/gcc/$M2_ROOT_TGT/11.2.0/install-tools/mkheaders

cd $M2_ROOT
rm -rf source/$SOURCE_DIR

set +x
